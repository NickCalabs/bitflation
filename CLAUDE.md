# Bitflation

Bitcoin inflation-adjusted price visualizer. Shows BTC priced in "real" dollars using CPI, M2, Gold, and DXY deflators.

## Status

- **V1:** CPI-adjusted BTC chart
- **V2:** M2, Gold, DXY metrics + log scale
- **V3:** Real-time data (FRED API), landing page explainer, shareable URLs, calculator — DONE
- **V3 backlog:** Event annotations, multi-asset comparison — NOT STARTED

## Tech Stack

- **React 19** + **TypeScript 5.9** (strict mode, no emit)
- **Vite 7** (dev server, bundler)
- **Recharts 3** (charting)
- **date-fns 4** (date utilities — currently light usage)
- **CSS Modules** (scoped component styles, no CSS-in-JS)
- No state management library — plain `useState` + `useMemo`

## Project Structure

```
src/
├── App.tsx                  # Root component, data pipeline, all state
├── main.tsx                 # React DOM entry
├── styles/global.css        # CSS variables, resets, dark theme
├── lib/                     # Pure functions, no React imports
│   ├── types.ts             # All shared TypeScript interfaces/types
│   ├── adjustPrices.ts      # Deflator-based price adjustment
│   ├── convertToGold.ts     # BTC → gold ounces conversion
│   ├── calculateReturns.ts  # Real returns computation (nominal/CPI/M2/gold)
│   ├── fetchFred.ts         # Generic FRED JSON API fetcher (DXY, M2)
│   ├── fetchLivePrices.ts   # CoinGecko API (365d rolling BTC)
│   ├── filterByTimeframe.ts # 1Y/5Y/ALL date filtering
│   ├── formatters.ts        # Intl.NumberFormat wrappers
│   ├── interpolateCpi.ts    # Monthly → daily linear interpolation
│   ├── stitchPrices.ts      # Merge static + live price/deflator arrays
│   └── urlState.ts          # URL param parse/write for shareable links
├── components/              # React components (each .tsx + .module.css)
│   ├── Header.tsx
│   ├── HeroPrice.tsx        # Large current price display
│   ├── Controls.tsx         # Anchor year, timeframe, metric, scale, share button
│   ├── PriceChart.tsx       # Recharts line chart (dual Y-axis for Gold)
│   ├── CustomTooltip.tsx    # Recharts tooltip component
│   ├── Calculator.tsx       # Real returns calculator (collapsible)
│   ├── Explainer.tsx        # Landing page container (headline, prose)
│   ├── ShockStats.tsx       # 4 dynamic stat cards (since 2020)
│   ├── FourLenses.tsx       # Metric explanation cards (CPI/M2/Gold/DXY)
│   └── Footer.tsx           # Data attribution + live status badge
├── data/                    # Static JSON (generated by scripts/)
│   ├── btc-daily.json       # ~4,000 daily BTC prices (2013–2025)
│   ├── cpi-monthly.json     # ~194 monthly CPI-U values
│   ├── m2-monthly.json      # ~192 monthly M2 supply values
│   ├── gold-monthly.json    # ~187 monthly gold prices (LBMA)
│   └── dxy-daily.json       # ~5,841 daily dollar index values
scripts/                     # Node.js data fetchers (ES modules, .mjs)
├── prepare-btc-data.mjs     # CryptoCompare API
├── prepare-cpi-data.mjs     # BLS API
├── prepare-m2-data.mjs      # FRED CSV
├── prepare-gold-data.mjs    # datahub.io CSV (FRED removed the daily series)
└── prepare-dxy-data.mjs     # FRED CSV
```

## Data Pipeline (App.tsx)

All state and data flow lives in `App.tsx`. No context providers, no reducers.

```
Static JSON + live fetches (CoinGecko BTC, FRED DXY + M2)
  → stitchPrices / stitchDeflators (merge, live wins on overlap)
  → interpolateMonthlyToDaily (CPI, M2, Gold → Map<date, value>)
  → branch on metric:
      CPI/M2/DXY → adjustPrices(prices, deflatorMap, anchorYear)
      GOLD       → convertToGold(prices, goldMap)
  → filterByTimeframe(data, '1Y'|'5Y'|'ALL')
  → render chart + calculator + explainer
```

Key types flowing through the pipeline:
- `PricePoint` → raw `{ date, price }`
- `AdjustedPricePoint` → `{ date, nominalPrice, adjustedPrice }` (CPI/M2/DXY)
- `GoldPricePoint` → `{ date, nominalPrice, goldOunces, goldPriceUsd }` (Gold)
- `LiveDataStatus` → `'all' | 'partial' | 'none'`
- `CalculatorResult` → computed returns (nominal/CPI/M2/gold values + percentages)

## Key Patterns

**Deflator math:** `adjustedPrice = nominalPrice × (deflatorAnchor / deflatorCurrent)` where anchor is the average deflator value for the selected year.

**Monthly → daily interpolation:** Linear interpolation between monthly data points, then flat-hold for 90 days past last data point. Used for CPI, M2, and Gold. DXY is already daily (forward-filled for weekends/holidays). Gold is monthly because FRED removed the daily LBMA series — interpolated daily gold prices are slightly less accurate during volatile gold days, but sufficient for the visualization.

**Map-based lookups:** All deflator data stored as `Map<string, number>` keyed by `YYYY-MM-DD` for O(1) date lookups.

**Graceful degradation:** If API keys are missing or requests fail, app works from static data. Footer badge shows three states: green (all live), yellow (partial), red (static only). Gold has no live FRED source (daily LBMA series was discontinued) — only static data from datahub.io.

**Shareable URLs:** Controls state syncs to URL params (`metric`, `anchor`, `tf`, `log`) via `history.replaceState`. Only non-default values are written to keep URLs clean. State is read from URL on initial load.

**Log scale safety:** Recharts log scale breaks on values ≤ 0, so `PriceChart` filters those out before rendering when `logScale` is true. Domain minimum is set to `1`.

## Conventions

- **CSS Modules only** — every component gets `ComponentName.module.css`, imported as `styles`
- **Named exports** for components, default export only for `App`
- **No barrel files** — import directly from the file
- **Pure lib functions** — `src/lib/` has zero React imports, all pure data transforms
- **Dates as strings** — `YYYY-MM-DD` throughout, compared lexicographically
- **`useMemo` for all computed data** — no derived state in `useState`
- **Chart animations** — 600ms ease-in-out on line transitions for smooth metric switching
- **Color palette:** indigo (`#818cf8`) = nominal, green (`#4ade80`) = adjusted, yellow (`#facc15`) = gold, red (`#f87171`) = negative/loss

## Environment Variables

```
VITE_COINGECKO_API_KEY=   # CoinGecko demo API key (optional, live data)
VITE_FRED_API_KEY=        # FRED API key (live DXY + M2 data, also used by data scripts)
```

## Commands

```bash
npm run dev       # Vite dev server
npm run build     # tsc -b && vite build
npm run preview   # Preview production build
npm run lint      # ESLint
```

Data scripts run standalone:
```bash
node scripts/prepare-btc-data.mjs
node scripts/prepare-cpi-data.mjs
node scripts/prepare-m2-data.mjs
node scripts/prepare-gold-data.mjs
node scripts/prepare-dxy-data.mjs
```

## Git Workflow

- Commit after each feature is working, not all at once.
- Use conventional commits (feat:, fix:, refactor:).
- Never add Co-authored-by trailers.
- Push to origin when the session is complete.

## Rules

<!-- Add your own rules below this line -->
